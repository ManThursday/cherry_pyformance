<!DOCTYPE html>
<html>
<head>

  <title>${statement[1] if len(statement[1])<50 else statement[1][:47]+'...'}</title>

  <style type="text/css" title="currentStyle">
    @import "/css/jquery-ui-1.10.3.custom.min.css";
    @import "/css/sh_acid.min.css";
    @import "/css/jquery.dataTables.css";
    pre{font-size: 12pt;
        margin: 0 auto;
        width: 800px;}
    path{fill:none;
        stroke:black;
        stroke-width:2px;}
    svg{border: 1px black solid;}
    datum{cursor:pointer;}
  </style>

  <script type="text/javascript" src="/js/jquery.js"></script>
  <script type="text/javascript" src="/js/jquery-ui-1.10.3.custom.min.js"></script>
  <script type="text/javascript" src="/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="/js/sh_main.min.js"></script>
  <script type="text/javascript" src="/js/sh_sql.min.js"></script>
  <script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

  <script type="text/javascript">
    $(document).ready(function(){


      var height=400;
      var width=700;
      var margin=50;

      function draw(data){

        d3.select('body')
          .append('svg')
            .attr('width',width)
            .attr('height',height)
          .selectAll('circle')
          .data(data)
          .enter()
          .append('circle')

        var x_extent = d3.extent(data, function(d){return d[1]*1000});
        var x_scale = d3.time.scale()
                          .range([margin,width-margin])
                          .domain(x_extent);
        var y_extent = d3.extent(data, function(d){return d[0]});
        var y_scale = d3.scale.linear()
                              .range([height-margin,margin])
                              .domain(y_extent);
        d3.selectAll('circle')
                    .attr('cx', function(d){return x_scale(d[1]*1000)})
                    .attr('cy', function(d){return y_scale(d[0])})
                    .attr('r',5)
                    .attr('class','datum')
                    .attr('data-id',function(d){return d[2]});

        var line = d3.svg.line()
                         .x(function(d){return x_scale(d[1]*1000)})
                         .y(function(d){return y_scale(d[0])});
        d3.select('svg')
          .append('path')
            .attr('d',line(data));

        var x_axis = d3.svg.axis().scale(x_scale);
        d3.select('svg')
          .append('g')
            .attr('class','x axis')
            .attr('transform', 'translate(0,'+(height-margin)+')')
          .call(x_axis);
      
        var y_axis = d3.svg.axis().scale(y_scale).orient('left');
        d3.select('svg')
          .append('g')
            .attr('class','y axis')
            .attr('transform', 'translate('+margin+', 0)')
          .call(y_axis);
      
        //mouseover points
        $('.datum').hover(function(e){
            $(this).attr({'stroke':'black',
                          'stroke-width':2,
                          'fill':'red',
                          'r':7});
          },function(e){
            $(this).attr({'fill':'black',
                         'r':5});
        }).click(function(){
          id = $(this).attr('data-id');
          window.location.href = '/sqlstatements/'+id;
        });
      
      };

      


      function parseJSON(data){
        statement = data[0];

        dataHtml = '';
        dataHtml += '<tr><td>count:</td><td>'+statement[2]+'</td></tr>';
        dataHtml += '<tr><td>avg:</td><td>'+statement[3]+'</td></tr>';
        dataHtml += '<tr><td>min:</td><td>'+statement[4]+'</td></tr>';
        dataHtml += '<tr><td>max:</td><td>'+statement[5]+'</td></tr>';
        $('#data').html(dataHtml);

        //highlight sql syntax
        sh_highlightDocument();
        
        //remove any graphs
        $('svg').remove();
        //draw graph
        draw(statement[6]);

      };
      
      function noDataError() {
        $('svg').remove();
        $('#data').html('<p>No data.</p>')
        
      }


      $.getJSON('/api/sqlstatements/${statement[0]}?${encoded_kwargs}', parseJSON, noDataError);

      function dpChange(e){
        var start_date = new Date($('#datepick1').val())/1000;
        var end_date = new Date($('#datepick2').val())/1000;
        var dateLimit = '';
        if (start_date){dateLimit+='start_date='+start_date+'&'};
        if (end_date){dateLimit+='end_date='+end_date+'&'};
        $.getJSON('/api/sqlstatements/${statement[0]}?'+dateLimit+'${encoded_kwargs}', parseJSON, noDataError);
      };
      $.datepicker.formatDate('@');
      $('#datepick1').datepicker().change(dpChange);
      $('#datepick2').datepicker().change(dpChange);


    });
  </script>
</head>
<body>

  <a href="/">Home</a>&nbsp;&nbsp;&gt;&nbsp;&nbsp;<a href="/sqlstatements">Aggregated SQL</a>&nbsp;&nbsp;&gt;&nbsp;&nbsp;Statement
  <div>
    <pre class="sh_sql">${statement[1].replace(', ',',\n      ').replace('AND','\n  AND')}</pre>
  </div>
  <form>
    <p>From:<input type="text" id="datepick1">   To:<input type="text" id="datepick2"></p>
  </form>
  <table id="data"></table>


</body>
</html>
